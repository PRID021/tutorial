---
layout: ../../layouts/MarkdownPostLayout.astro
title: "Continues integrate, continue deploy Flutter project with GitHub Action, FastLane Part 2. "
pubDate: 2024-04-18
description: "CI/CD Flutter project in workplace."
author: "Hoang Pham"
image:
  url: "https://lh3.googleusercontent.com/drive-viewer/AKGpiha4X1CH_tBlX-fqunz0fINybDxevmwkIEPlfUGG50Len2NvIJuNKe47xw7VN9KX9zKh7ak-xiPwYD84LLJlQzN4AhkFIyp6xhI=s1600-rw-v1"
  alt: "CI/CD illustration life cycle."
tags: ["flutter", "git-action", "fastlane"]
---

Continue for the Part 1 of this tutorial. Today we will working with IOS to comprehensive our workflow. To follow this part you will have to be prerequisites to enroll with Apple Development Programming.
w<br><br>

## Setup fastlane for IOS.

The same with Android, we navigate to ios folder and perform: <br>
<br>

```sh

    fastlane init

```

<br>
It will automatic detect platform and suggest some default setup, we will choose the option manually setup for now. <br>

We will edit our `Gemfile` with some content, fulfill our file with this content: <br><br>

```sh

    source "https://rubygems.org"

    gem 'fastlane','~>2.219.0'
    gem 'cocoapods','~>1.15.2'
    gem 'rubyzip', '2.3.2'

    plugins_path = File.join(File.dirname(__FILE__), 'fastlane', 'Pluginfile')
    eval_gemfile(plugins_path) if File.exist?(plugins_path)

```

<br>
By specific the versions of fastlane we can avoid bundle install unstable fastlane versions. Navigate to fastlane folder and create `.env.development` for development environment with some content like this: <br>

```sh

    PROJECT_NAME="Runner"
    SCHEME="dev"
    TARGET_NAME="Runner"
    BUNDLE_IDENTIFIER="<your-app-bundle-identifier>"
    IPA_NAME="<your ipa artifact name>"
    # Using adhoc type to create artifact upload to Firebase App Distribution.
    EXPORTMETHOD="ad-hoc"
    CONFIG="Release Development"
    # When enroll to Apple Develop Programming, you will get this ID for your team.
    TEAM_ID="<your team id>"
    # For match auto detect your build type
    MATCH_TYPE="adhoc"
    # This is the name branch used to store all certificate and provisioning use be fastlane to auto match and share between ours team member.
    MATCH_GIT_BRANCH="<your certificate and provisioning repo branch>"
    # Password used to encrypt/decrypt certificates
    MATCH_PASSWORD=123321
    FIREBASE_APP_DISTRIBUTION="1:141813576827:ios:4faa401912fb6fbcb84dede"
    FIREBASE_GROUP="tester-ios"
    DEPLOY_MODE=firebase
    APPLE_ID="<your apple id>"
    TEAM_NAME="<your team name>"
    # This use to notify stakeholder about new app version release.
    MATTERMOST_URL="<matter most url channel>"
    APP_VERSION="0.0.1+20042401"
    PLATFORM="IOS"
    APP_URL="<your app url issue by firebase distribution>"

```

<br>
Go next to `Appfile` where will defined all common setup for all `lane` of fastlane and setup it with some common define like this: 
<br><br>

```sh

    app_identifier ENV['BUNDLE_IDENTIFIER']
    team_id ENV['TEAM_ID']

```

<br><br>

We can use an `devices.text` that content all device UUID that have been approve to test our app in these device, it will have the format like that:
<br><br>

```txt

    Device ID	Device Name	Device Platform
    00008030-001A14261246402E	user.A@company.com - iPhone 11	ios
    00008110-00061D2A0050401E	user.B - iPhone 13 Pro Max	ios

```

<br><br>

Create an `Matchfile` that will be use by our `match` tool:
<br><br>

```sh

    username("example.dev@company.asia")
    git_url("git@github.com:example/apple_certificates.git")
    git_branch(ENV['MATCH_GIT_BRANCH'])
    type(ENV['MATCH_TYPE'])
    storage_mode("git")
    username(ENV['APPLE_ID'])
    team_id(ENV['TEAM_ID'])

```

<br><br>

Create an `Pluginfile` that defined the third party we use to help use easier when deploy beta product to firebase and notify out stakeholder.
<br><br>

```sh

    # Autogenerated by fastlane
    #
    # Ensure this file is checked in to source control!
    gem 'fastlane-plugin-firebase_app_distribution'
    gem 'fastlane-plugin-changelog'
    gem 'fastlane-plugin-mattermost'

```

<br><br>

Ok!, a lot of setup, now we will move on to the main defy out fastlane `lane`, open `Fastfile` you will seem currently it have been fill with some content like this:
<br>

```sh
    default_platform(:ios)

    platform :ios do
    # Other stuff....
```

<br><br>

First inside of this file we write an lane profile to get certificates and provisioning file. <br>

```sh

   lane :profile do |options|
        match(
          type: 'development',
          force_for_new_devices: true,
          readonly: options[:readonly],
          app_identifier: ENV['BUNDLE_IDENTIFIER'],
          output_path: 'build',
        )
        match(
         type: 'adhoc',
          force_for_new_devices: true,
          readonly: options[:readonly],
          app_identifier: ENV['BUNDLE_IDENTIFIER'],
          output_path: 'build',
        )
   end

```

<br>

This lane when execute via <br>

```sh

    bundle exec fastlane profile readonly:false --env development

```

<br><br>

will use configs that we defined in `Matchfile`, go to git specific branch on our certificate repo and download the certificate if exist else it will prompt suggestion to create an new certificates, provisioning files and auto save .cer and .p12, provisioning files in that repo for subsequence invoke.

<br>
<img src="https://lh3.googleusercontent.com/drive-viewer/AKGpihaMRFvNJbQ-4KuYNWNLisBzA24OlJAbHVpTVUCXitl_fsMZR-mee44s7_qbLeOEcj4oKa29tee8zWh43JSQ12tc0yV87V8zWb0=s1600-rw-v1" width="100%" >
<br>

<br><br>
If your xcode does'nt find appropriate certificate for specific provisioning profile, it maybe due to the conflict key chain so before execute this lane make sure you remove any not used certificate, and reset pc after execute this lane.

<br>
We can defy another lane to register our test devices instead of manual  edit on apple  develope web portal like this. <br>

<br><br>

```sh

   desc "Register iOS devices to Apple Developer Portal"
   lane :register_iOS_devices do
      register_devices(
        devices_file: "./fastlane/devices.txt",
        platform: "ios",
        team_name: ENV['TEAM_NAME'],
      )
   end

```

<br><br>

When execute it will load devices in `devices.text` file that we predefined and upload our provisioning, remember to update our provisioning file in certificate repo on previous step.
<br>

Come to deploy phase we will write something like this, it up to you to defy your workflow, here is one example :

<br><br>

```sh

   desc "Get certificates for build"
   lane :get_certificate do
      sync_code_signing(
        app_identifier: ENV['BUNDLE_IDENTIFIER'],
        readonly: true
      )
    end

   # Archive app
   lane :build do
       get_certificate
       build_app(
            scheme: ENV['SCHEME'],
            export_method: ENV['EXPORTMETHOD'],
            output_directory: 'build',
            output_name: ENV['IPA_NAME'],
            configuration: ENV['CONFIG'],
            clean: true,
            include_symbols: true
       )
   end

    # Deploy - Deploy mode
    lane :deploy do
        if ENV['DEPLOY_MODE'] == "firebase"
            deploy_firebase
        end
    end

    desc "Upload archive to firebase app distribution"
    lane :deploy_firebase do
        firebase_app_distribution(
            app: ENV['FIREBASE_APP_DISTRIBUTION'],
            groups: ENV['FIREBASE_GROUP'],
            ipa_path: 'build/' + ENV['IPA_NAME'] + '.ipa',
            firebase_cli_token: ENV['FIREBASE_CLI_TOKEN'],
            release_notes: File.read("../../release-note.txt")
        )
        send_message
    end

    desc "Send message on mattermost channel for ios"
    lane :send_message do
    mattermost(
        url: ENV["MATTERMOST_URL"],
        text: "![](https://img.shields.io/badge/#{ENV["PLATFORM"]}-3087ff?label=env) ![](https://img.shields.io/badge/#{ENV["APP_VERSION"]}-red?label=version)\n Release mobile app done! :meow_dance: :meow_dance: :meow_dance: \n URL: #{ENV["APP_URL"]}\n #### :edit_list: Release notes: \n #{File.read("../../release-note.txt")}" ,
        username: "RELEASE-BOT",
        icon_url: "https://lh3.googleusercontent.com/drive-viewer/AKGpihbbxkBMx8pRsdAoMyz4TxBsY-cq1NTy_eu0xFHhbYHxM4gYtfIsXrms2oaTwidVar7DqnW5if1W4E4vlc-y5NZvL__Z5b6pJw=s2560"
    )
    end

```

<br>

The final remain is to setup our ci/cd workflow on github action.
<br><br>

```sh

  build-and-release-ios:
    name: Build and release iOS
    runs-on: [self-hosted, macOS]
    needs: set-up
    steps:
      - name: Check out the repository to the runner
        uses: actions/checkout@v4
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Run a script
        run: |
          chmod +x ./release-dev-ios.sh
          export FIREBASE_CLI_TOKEN=${{secrets.FIREBASE_CLI_TOKEN}}
          ./release-dev-ios.sh

```

<br><br>

In order to git action have permission to go to certificate repo we must config ssh-agent here i used `webfactory/ssh-agent@v0.9.0`. And predefined an `release-dev-ios.sh` similar as on Android.

<br><br>

```sh

    fvm flutter clean
    fvm flutter pub get
    fvm flutter precache --ios
    cd ios || exit
    make prepare
    make pod
    make profile READ=false  ENV=development
    make dev
    cd ..

```

<br><br>

our `ios/Makefile` with this content: <br>

```sh

    READ ?= true

    prepare:
        bundle install
        bundle update

    pod:
        bundle exec pod repo update
        bundle exec pod install --repo-update

    profile:
        bundle exec fastlane profile readonly:$(READ) --env $(ENV)

    profiles:
        bundle exec fastlane profile readonly:true --env development
        bundle exec fastlane profile readonly:true --env production
        bundle exec fastlane profile readonly:true --env appstore

    dev:
        bundle exec fastlane build --env development
        bundle exec fastlane deploy --env development
    prod:
        bundle exec fastlane build --env production
        bundle exec fastlane deploy --env production

    release:
        bundle exec fastlane build --env appstore
        bundle exec fastlane deploy --env appstore

```

<br><br>

**Hmw hmw, that is the end of this serials ci/cd, i hope this serials will help those with the begin point to learn ci/cd in Flutter**
